<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard - Clínica SaludPlus</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* Estilos adaptados al diseño de pacientes/citas */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding-bottom:40px;color:#333}
.navbar{background:linear-gradient(90deg,#004a99 0%,#003366 100%);color:#fff;padding:0;box-shadow:0 4px 12px rgba(0,0,0,.15);position:sticky;top:0;z-index:1000}
.navbar-content{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.navbar h1{font-size:22px;display:flex;gap:10px;align-items:center}
.navbar-menu{display:flex;gap:16px;list-style:none}
.navbar-menu a{color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px;transition:all .2s;font-size:14px}
.navbar-menu a:hover,.navbar-menu a.active{background:rgba(255,255,255,.12)}
.container{max-width:1200px;margin:20px auto;padding:0 20px}
.header {display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.header h2{color:#fff;font-size:28px;display:flex;align-items:center;gap:10px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:20px}
.card{background:white;border-radius:12px;padding:18px;box-shadow:0 4px 12px rgba(0,0,0,.1);text-align:center}
.card h3{margin:0;color:#004a99;font-size:14px}
.card p{font-size:26px;margin-top:8px;color:#333}
.loader{display:none;text-align:center;padding:20px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.loader.show{display:block}
.spinner{width:36px;height:36px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.table-card{background:white;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;text-align:left;border-bottom:1px solid #eee}
th{background:linear-gradient(90deg,#f7f9ff,#f0f4ff);color:#003366}
.estado{padding:6px 10px;border-radius:12px;color:white;font-weight:600;text-transform:capitalize}
.programada{background:#28a745}
.cancelada{background:#dc3545}
.completada{background:#ffc107;color:#333}
.alert{padding:12px 14px;border-radius:8px;margin-bottom:12px;display:none}
.alert.show{display:block}
.alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
@media(max-width:768px){.header{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<nav class="navbar">
  <div class="navbar-content">
    <h1><i class="fas fa-clinic-medical"></i> Clínica SaludPlus</h1>
    <ul class="navbar-menu">
      <li><a href="index.html" class="active"><i class="fas fa-home"></i> Inicio</a></li>
      <li><a href="pacientes.html"><i class="fas fa-users"></i> Pacientes</a></li>
      <li><a href="doctores.html"><i class="fas fa-user-md"></i> Doctores</a></li>
      <li><a href="citas.html"><i class="fas fa-calendar"></i> Citas</a></li>
    </ul>
  </div>
</nav>

<div class="container">
  <div class="header">
    <h2><i class="fas fa-chart-pie"></i> Panel de control</h2>
    
  </div>

  <div class="alert alert-success" id="alertSuccess"></div>
  <div class="alert alert-error" id="alertError"></div>

  <div id="loader" class="loader">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <div class="cards" id="statsCards">
    <div class="card">
      <h3>Total Pacientes</h3>
      <p id="totalPacientes">0</p>
    </div>
    <div class="card">
      <h3>Total Doctores</h3>
      <p id="totalDoctores">0</p>
    </div>
    <div class="card">
      <h3>Citas Hoy</h3>
      <p id="citasHoy">0</p>
    </div>
    <div class="card">
      <h3>Citas Próximas 24h</h3>
      <p id="citasProximas">0</p>
    </div>
  </div>

  <div class="table-card">
    <h3 style="margin:0 0 12px 0;"><i class="fas fa-calendar-day"></i> Citas para hoy</h3>
    <div id="msgCitasHoy" style="margin-bottom:10px;color:#333"></div>
    <table id="tablaCitasHoy">
      <thead>
        <tr><th>Hora</th><th>Paciente</th><th>Doctor</th><th>Estado</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="api.js"></script>
<script>
function showAlert(msg, type='success', time=3000){
  const el = document.getElementById(type==='success'?'alertSuccess':'alertError');
  el.textContent = msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), time);
}

async function cargarEstadisticas(){
  document.getElementById('loader').classList.add('show');
  try{
    const resPac = await api.pacientes.getAll();
    const pacientes = resPac.data || [];
    document.getElementById('totalPacientes').textContent = pacientes.length;

    const resDoc = await api.doctores.getAll();
    const doctores = resDoc.data || [];
    document.getElementById('totalDoctores').textContent = doctores.length;

    const hoy = new Date().toISOString().split('T')[0];
    const resCitas = await api.citas.getAll({ fecha: hoy });
    const citasHoy = resCitas.data || [];
    document.getElementById('citasHoy').textContent = citasHoy.length;

    // proximas 24h (filtrado en frontend)
    const resAll = await api.citas.getAll();
    const todas = resAll.data || [];
    const ahora = new Date();
    const next24 = new Date(ahora.getTime() + 24*60*60*1000);
    const prox24 = (todas || []).filter(c => {
      if (c.estado !== 'programada') return false;
      const dt = new Date(`${c.fecha}T${c.hora}`);
      return dt > ahora && dt <= next24;
    });
    document.getElementById('citasProximas').textContent = prox24.length;

    cargarTablaCitasHoy(citasHoy);
  }catch(err){
    console.error(err);
    showAlert('Error cargando estadísticas','error',5000);
  }finally{
    document.getElementById('loader').classList.remove('show');
  }
}

async function cargarTablaCitasHoy(citas){
  const tbody = document.querySelector('#tablaCitasHoy tbody');
  tbody.innerHTML = '';
  if(!citas || citas.length===0){
    document.getElementById('msgCitasHoy').innerText = 'No hay citas programadas para hoy.';
    return;
  }
  document.getElementById('msgCitasHoy').innerText = '';
  // obtener mapas para nombres
  const resPac = await api.pacientes.getAll();
  const pacMap = (resPac.data||[]).reduce((m,p)=>{m[p.id]=p.nombre;return m},{});
  const resDoc = await api.doctores.getAll();
  const docMap = (resDoc.data||[]).reduce((m,d)=>{m[d.id]=d.nombre;return m},{});

  citas.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.hora || 'N/A'}</td>
      <td>${pacMap[c.pacienteId] || c.pacienteId || 'Desconocido'}</td>
      <td>${docMap[c.doctorId] || c.doctorId || 'Desconocido'}</td>
      <td><span class="estado ${c.estado}">${c.estado || 'N/A'}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

document.addEventListener('DOMContentLoaded', cargarEstadisticas);
</script>
</body>
</html>
